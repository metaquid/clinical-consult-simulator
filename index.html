<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Consult Simulator</title>
    <!-- 
        Clinical Consult Simulator v7.2 (Final Polish & Feature Complete)
        - BUGFIX: Corrected a critical JavaScript syntax error that was preventing the application from running.
        - DEMO OVERHAUL: The guided tour is now fully interactive, activating UI elements like themes and modals as they are explained.
        - DEMO FEATURE: The demo case is now preserved after the tour finishes, leaving a ready-to-use template for the user's first training session.
        - CONTENT: Added more complex and high-stakes scenarios to the presets dropdown for advanced training.
        - FEATURE: Live debrief analysis now generates a richer, more detailed set of metrics for the graphs, matching the demo's quality.
        - CRITICAL FIX: Robustly corrected voice selection logic to ensure proper gender and accent assignment for all demo roles.
        --- REFACTOR v1.0 ---
        - DISABLED: NVIDIA API functionality has been completely removed due to client-side CORS restrictions.
        - SIMPLIFIED: API call logic, UI selectors, and local storage now only handle the Google Gemini API.
    -->
    <style>
        :root {
            --bg-color: #2f3640; --surface-color: #353b48; --primary-color: #00a8a8; --secondary-color: #718093; --success-color: #2e8b57; --text-color: #f5f6fa; --text-muted-color: #ced6e0; --border-color: #4a4a4c; --panel-shadow: 0 8px 25px rgba(0,0,0,0.5); --error-color: #c23616; --highlight-color: #ffb86c; --msg-patient-text: #ffffff; --msg-doctor-text: #ffffff;
        }
        html[data-theme='medical-blue'] { --bg-color: #f0f4f8; --surface-color: #ffffff; --primary-color: #005a9c; --secondary-color: #e1e8ed; --success-color: #005a9c; --text-color: #1c293b; --text-muted-color: #62748a; --border-color: #cdd7e1; --panel-shadow: 0 4px 15px rgba(0, 90, 156, 0.1); --error-color: #d9534f; --msg-patient-text: #1c293b; --msg-doctor-text: #ffffff; }
        html[data-theme='night-shift'] { --bg-color: #121212; --surface-color: #1e1e1e; --primary-color: #ffb86c; --secondary-color: #44475a; --success-color: #50fa7b; --text-color: #f8f8f2; --text-muted-color: #bd93f9; --border-color: #282a36; --panel-shadow: 0 8px 25px rgba(0,0,0,0.7); --error-color: #ff5555; --msg-patient-text: #f8f8f2; --msg-doctor-text: #1e1e1e; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; transition: background-color 0.3s, color 0.3s; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        header { padding: 1rem; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        header h1 { font-size: 1.3rem; color: var(--primary-color); }
        main { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #chat-window { display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 85%; padding: 0.75rem 1.2rem; border-radius: 12px; line-height: 1.6; word-wrap: break-word; animation: fadeIn 0.3s ease-in; }
        .message.system { background-color: #3a3a3c; color: var(--primary-color); font-style: italic; text-align: center; align-self: center; border-radius: 8px; font-size: 0.9rem; }
        .message.error { background-color: var(--error-color); color: #fff; text-align: center; align-self: center; border-radius: 8px; font-size: 0.9rem; }
        .message.patient { background-color: var(--secondary-color); color: var(--msg-patient-text); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.doctor { background-color: var(--success-color); color: var(--msg-doctor-text); align-self: flex-end; border-bottom-right-radius: 4px;}
        .message .author { font-weight: bold; display: block; margin-bottom: 0.25rem; font-size: 0.8rem; opacity: 0.8; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #settings-panel, #help-modal { position: fixed; top: 0; left: -100%; width: 90%; max-width: 500px; height: 100%; background-color: #242426; box-shadow: var(--panel-shadow); transition: left 0.35s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        #help-modal { z-index: 1001; }
        #settings-panel.open, #help-modal.open { left: 0; }
        .panel-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .panel-header h2 { color: var(--primary-color); }
        .panel-content { padding: 1.2rem; overflow-y: auto; flex-grow: 1; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted-color); }
        .voice-selection { display: flex; align-items: center; gap: 0.5rem; }
        .voice-selection select { flex-grow: 1; }
        .voice-selection button { flex-shrink: 0; padding: 0.5rem; width: 40px; height: 40px; font-size: 1.2rem; }
        input, select, textarea { width: 100%; padding: 0.8rem; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 30%, transparent); outline: none; }
        textarea { min-height: 140px; resize: vertical; }
        input:disabled, select:disabled, textarea:disabled, option:disabled, button:disabled { background-color: #3d3d3d; opacity: 0.6; cursor: not-allowed; color: var(--text-muted-color); }
        button { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: all 0.2s; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        button:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: var(--msg-doctor-text); }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.2); }
        .btn-primary:disabled { background-color: #555; color: #888; cursor: not-allowed; filter: none; }
        .btn-secondary { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--surface-color) 80%, white); }
        .btn-success { background-color: var(--success-color); color: var(--msg-doctor-text); }
        .btn-success:hover:not(:disabled) { filter: brightness(1.2); }
        .btn-danger { background-color: var(--error-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { filter: brightness(1.2); }
        #controls { display: flex; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--surface-color); }
        .control-group { display: flex; gap: 1rem; width: 100%; }
        #simulation-status { background-color: var(--surface-color); padding: 0.8rem; border-radius: 8px; text-align: center; display: none; margin-bottom: 1rem; }
        #status-text { font-weight: bold; margin-bottom: 0.5rem; }
        #tour-prompt { margin-top: 1rem; }
        #performance-analysis-summary { background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 8px; display: none; }
        #performance-analysis-summary h3 { color: var(--success-color); margin-bottom: 1rem; }
        .highlight-pulse { animation: pulse 1.5s infinite; position: relative; z-index: 1; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--highlight-color) 70%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, var(--highlight-color) 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--highlight-color) 0%, transparent); } }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; padding-top: 1rem; }
        .bar-chart-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .bar-item { display: flex; align-items: center; gap: 1rem; }
        .bar-label { width: 180px; text-align: right; font-size: 0.9rem; flex-shrink: 0; color: var(--text-muted-color); }
        .bar-wrapper { flex-grow: 1; background-color: var(--bg-color); border-radius: 3px; }
        .bar { height: 20px; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); border-radius: 3px; animation: barGrow 1s ease-out; }
        @keyframes barGrow { from { width: 0; } }
        .bar-value { font-size: 0.9rem; }
        .tab-buttons { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-button { flex: 1; padding: 1rem; background: none; border: none; color: var(--text-muted-color); cursor: pointer; font-size: 1rem; }
        .tab-button.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        .mode-container { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .mode-container label { cursor: pointer; flex-grow: 1; -webkit-user-select: none; user-select: none; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink: 0; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .theme-switcher { position: relative; }
        .theme-menu { display: none; position: absolute; top: 110%; right: 0; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: var(--panel-shadow); z-index: 100; }
        .theme-menu button { display: block; width: 100%; text-align: left; background: none; color: var(--text-color); }
        .theme-menu button:hover { background-color: var(--primary-color); color: var(--msg-doctor-text); }
        #demo-splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #demo-splash-screen h1 { font-size: 2.5rem; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); padding-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div id="demo-splash-screen"><h1>Clinical Consult Simulator</h1></div>
    <div id="app-container"></div>
    <script>
        const app = {
            dom: {},
            state: { isSimulationRunning: false, isInitializing: false, conversationHistory: [], audioEnabled: false, voices: [], demoVoices: { narrator: null, doctor: null, patient: null }, postDemoTransition: false },
            async init() {
                document.getElementById('app-container').innerHTML = `
                <div id="help-modal"><div class="panel-header"><h2>User Guide</h2><button id="close-help-btn" class="btn-secondary">&times;</button></div><div class="panel-content modal-content"><h3>Welcome to the Clinical Consult Simulator</h3><p>This tool has three modes to help you practice and improve doctor-patient communication.</p><hr style="margin: 1rem 0; border-color: var(--border-color);"><h4><strong>Demo Mode</strong></h4><p>Click "Start Guided Tour" to see how a pre-scripted case is configured. You will then be prompted to watch an automated dialogue to see a "best practice" example and the kind of performance feedback the tool provides.</p><h4><strong>Training Mode (Manual)</strong></h4><p>Your role is to act as the <strong>Doctor</strong> and engage in a dialogue with an AI-driven <strong>Patient</strong>.</p><ol><li><strong>SETUP:</strong> Disable "Demo Mode". In the 'Setup' tab, enter your API key(s).</li><li><strong>PATIENT & SCENARIO:</strong> Configure the patient profile, scenario context, and voices.</li><li><strong>CONSULT:</strong> Click 'Start Consultation'. The AI patient will generate an opening line. Use the input box to type your responses.</li><li><strong>DEBRIEF:</strong> When you're ready, click 'Request Debrief' to receive a personalized report.</li></ol><h4><strong>Training Mode (AI Doctor)</strong></h4><p>Your role is to <strong>Observe</strong>. The AI will play both the Doctor and the Patient. Use this to see how the AI handles different scenarios.</p></div></div>
                <div id="settings-panel"><div class="panel-header"><h2>Case Configuration</h2><button id="close-settings-btn" class="btn-secondary">&times;</button></div><div class="panel-content"><div class="tab-buttons"><button class="tab-button active" data-tab="setup">1. Setup</button><button class="tab-button" data-tab="patient-profile">2. Patient Profile</button><button class="tab-button" data-tab="clinical-scenario">3. Clinical Scenario</button></div><div id="tab-setup" class="tab-content active"><h3>Operation Modes</h3><div class="mode-container" id="tour-demo-mode"><label for="demo-mode-toggle"><strong>Demo Mode</strong><br><small>Observe a pre-scripted case.</small></label><div class="switch"><input type="checkbox" id="demo-mode-toggle" checked><span class="slider"></span></div></div><div class="mode-container" id="tour-ai-doctor-mode"><label for="ai-doctor-mode-toggle"><strong>AI Doctor Mode</strong><br><small>Let the AI respond as the doctor.</small></label><div class="switch"><input type="checkbox" id="ai-doctor-mode-toggle"><span class="slider"></span></div></div><hr style="margin: 2rem 0;"><h3 id="tour-api-keys">API Keys & Data</h3><div class="form-group"><label for="google-api-key">Google Gemini API Key</label><input type="password" id="google-api-key" placeholder="For simulation and analysis"></div><div class="form-group"><label for="nvidia-api-key">NVIDIA API Key (Optional)</label><input type="password" id="nvidia-api-key" placeholder="NVIDIA API non supportato in questa versione" disabled></div><hr style="margin: 2rem 0;"><h3 id="tour-case-data">Case Data</h3><div style="display: flex; gap: 1rem;"><button id="export-case-btn" class="btn-secondary" style="width: 50%;">Export Case</button><button id="import-case-btn" class="btn-secondary" style="width: 50%;">Import Case</button></div><div class="form-group" style="margin-top: 1rem;"><button id="reset-case-btn" class="btn-danger" style="width: 100%;">Reset Full Case</button></div><input type="file" id="case-file-input" style="display: none;" accept=".json"></div><div id="tab-patient-profile" class="tab-content"><h3>Generate Patient Profile</h3><div class="form-group" id="tour-patient-symptoms"><label for="patient-symptoms">Key Symptoms (e.g., chronic headache, fatigue)</label><input type="text" id="patient-symptoms"></div><div class="form-group" id="tour-patient-archetype"><label for="patient-archetype">Patient Archetype (e.g., anxious, skeptical, stoic)</label><input type="text" id="patient-archetype"></div><button id="generate-patient-btn" class="btn-success" style="width: 100%;">Generate Profile via LLM</button><div id="persona-generation-status" style="display: none; text-align: center; margin-top: 0.5rem;"></div><hr style="margin: 1.5rem 0; border-color: var(--border-color);"><h4 id="tour-patient-ai">Patient AI & Voice</h4><div class="form-group"><label for="patient-llm">Patient LLM Model</label><select id="patient-llm"><option value="gemini-pro" selected>Google Gemini Pro</option></select></div><div class="form-group"><label for="patient-voice">Patient Voice</label><div class="voice-selection"><select id="patient-voice"></select><button id="preview-patient-voice" class="btn-secondary">▶</button></div></div><textarea id="patient-personality" placeholder="Patient's detailed clinical profile will be generated here..."></textarea></div><div id="tab-clinical-scenario" class="tab-content"><h3>Clinical Scenario & Doctor AI</h3><div class="form-group" id="tour-scenario-presets"><label for="scenario-presets">Select a Scenario Preset</label><select id="scenario-presets"><option value="">-- Choose a starting point --</option><option value="Setting: A busy emergency room at night. Patient is pale and breathing heavily.">ER: Potential Cardiac Event</option><option value="Setting: A primary care clinic. You need to discuss unfavorable lab results with a long-time patient.">Primary Care: Breaking Bad News</option><option value="Setting: A specialist's office. The patient is highly anxious about their chronic condition and has many questions.">Specialist: Managing an Anxious Patient</option><option value="Setting: A telehealth consultation. A patient's family member is angry and demanding immediate answers about their condition.">Conflict: Angry Family Member</option><option value="Setting: An oncology ward. You need to deliver a terminal diagnosis to a patient you have known for a long time.">High-Stakes: Delivering Terminal Diagnosis</option><option value="Setting: A follow-up visit. A patient with a chronic illness is not adhering to their prescribed treatment plan.">Challenge: Non-Adherent Patient</option><option value="Setting: A post-operative review. You need to inform a patient that a complication occurred during their surgery.">Ethics: Disclosing a Medical Error</option></select></div><div class="form-group" id="tour-scenario-topic"><label for="simulation-topic">Describe the setting and the patient's initial state (or modify preset)</label><textarea id="simulation-topic" placeholder="e.g., Setting: A busy emergency room at night. Patient is pale and breathing heavily."></textarea></div><div class="form-group" id="tour-doctor-ai"><label for="doctor-llm">Doctor LLM Model (for AI Doctor Mode)</label><select id="doctor-llm"><option value="gemini-pro" selected>Google Gemini Pro</option></select></div><div class="form-group"><label for="doctor-voice">Doctor's Voice</label><div class="voice-selection"><select id="doctor-voice"></select><button id="preview-doctor-voice" class="btn-secondary">▶</button></div></div></div></div></div>
                <header><h1>Clinical Consult Simulator</h1><div style="display: flex; gap: 1rem; align-items: center;"><div class="theme-switcher"><button id="theme-btn" class="btn-secondary">Theme</button><div id="theme-menu" class="theme-menu"><button data-theme="teal">Teal (Default)</button><button data-theme="medical-blue">Medical Blue</button><button data-theme="night-shift">Night Shift</button></div></div><button id="audio-toggle-btn" class="btn-secondary">Audio: OFF</button><button id="open-help-btn" class="btn-secondary">Guide</button><button id="open-settings-btn" class="btn-secondary">Configure Case</button></div></header>
                <main id="main-content"><div id="simulation-status"><div id="status-text"></div><div id="tour-prompt"></div></div><div id="chat-window"></div><div id="performance-analysis-summary"></div></main>
                <div id="controls"><div class="control-group"><button id="start-simulation-btn" class="btn-primary" style="flex-grow: 1;">Start Guided Tour</button><input type="text" id="doctor-input" placeholder="Type your response..." style="display: none; flex-grow: 1;"><button id="send-message-btn" class="btn-primary" style="display: none;">Send</button><button id="get-suggestion-btn" class="btn-primary" style="display: none; flex-grow: 1;">Get Doctor's Suggested Response</button><button id="request-debrief-btn" class="btn-secondary" style="display: none;">Request Debrief</button><button id="reset-conversation-btn" class="btn-secondary">Reset Conversation</button></div></div>`;
                this.dom = {
                    demoSplashScreen: document.getElementById('demo-splash-screen'), settingsPanel: document.getElementById('settings-panel'), settingsPanelContent: document.querySelector('#settings-panel .panel-content'), openSettingsBtn: document.getElementById('open-settings-btn'), closeSettingsBtn: document.getElementById('close-settings-btn'), helpModal: document.getElementById('help-modal'), openHelpBtn: document.getElementById('open-help-btn'), closeHelpBtn: document.getElementById('close-help-btn'), chatWindow: document.getElementById('chat-window'), mainContent: document.getElementById('main-content'), analysisPanel: document.getElementById('performance-analysis-summary'), startBtn: document.getElementById('start-simulation-btn'), resetConversationBtn: document.getElementById('reset-conversation-btn'), resetCaseBtn: document.getElementById('reset-case-btn'), debriefBtn: document.getElementById('request-debrief-btn'), sendBtn: document.getElementById('send-message-btn'), getSuggestionBtn: document.getElementById('get-suggestion-btn'), doctorInput: document.getElementById('doctor-input'), demoModeToggle: document.getElementById('demo-mode-toggle'), aiDoctorModeToggle: document.getElementById('ai-doctor-mode-toggle'), exportCaseBtn: document.getElementById('export-case-btn'), importCaseBtn: document.getElementById('import-case-btn'), caseFileInput: document.getElementById('case-file-input'), googleApiKeyInput: document.getElementById('google-api-key'), nvidiaApiKeyInput: document.getElementById('nvidia-api-key'), tabButtons: document.querySelectorAll('.tab-button'), tabContents: document.querySelectorAll('.tab-content'), configFields: document.querySelectorAll('.form-group input, .form-group select, .form-group textarea, #tab-patient-profile button, #tab-setup #export-case-btn, #tab-setup #import-case-btn, #tab-setup #reset-case-btn'), statusPanel: document.getElementById('simulation-status'), statusText: document.getElementById('status-text'), tourPrompt: document.getElementById('tour-prompt'), personaGenStatus: document.getElementById('persona-generation-status'), generatePatientBtn: document.getElementById('generate-patient-btn'), patient: { llmSelect: document.getElementById('patient-llm'), voiceSelect: document.getElementById('patient-voice'), personalityText: document.getElementById('patient-personality') }, doctor: { llmSelect: document.getElementById('doctor-llm'), voiceSelect: document.getElementById('doctor-voice'), }, patientSymptomsInput: document.getElementById('patient-symptoms'), patientArchetypeInput: document.getElementById('patient-archetype'), topicInput: document.getElementById('simulation-topic'), scenarioPresets: document.getElementById('scenario-presets'), themeBtn: document.getElementById('theme-btn'), themeMenu: document.getElementById('theme-menu'), themeOptions: document.querySelectorAll('.theme-menu button'), audioToggleBtn: document.getElementById('audio-toggle-btn'), previewPatientVoiceBtn: document.getElementById('preview-patient-voice'), previewDoctorVoiceBtn: document.getElementById('preview-doctor-voice'),
                };
                this.addEventListeners();
                this.storage.loadApiKeys();
                this.storage.loadTheme();
                this.storage.loadAudioPref();
                await this.simulation.populateVoices();
                this.ui.clearAll();
            },

            addEventListeners() {
                this.dom.openSettingsBtn.addEventListener('click', () => this.ui.openPanel());
                this.dom.closeSettingsBtn.addEventListener('click', () => this.ui.closePanel());
                this.dom.startBtn.addEventListener('click', () => {
                    if (this.dom.demoModeToggle.checked) {
                        this.tour.start();
                    } else {
                        this.simulation.startInteractive();
                    }
                });
                this.dom.debriefBtn.addEventListener('click', () => this.simulation.analyze());
                this.dom.sendBtn.addEventListener('click', () => this.simulation.sendDoctorMessage());
                this.dom.doctorInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') this.simulation.sendDoctorMessage(); });
                this.dom.generatePatientBtn.addEventListener('click', () => this.simulation.generatePatientProfile());
                this.dom.resetConversationBtn.addEventListener('click', () => this.ui.resetConversation());
                this.dom.resetCaseBtn.addEventListener('click', () => this.ui.clearAll(true));
                this.dom.demoModeToggle.addEventListener('change', () => this.ui.handleDemoToggle());
                this.dom.aiDoctorModeToggle.addEventListener('change', () => this.ui.handleAiDoctorToggle());
                this.dom.tabButtons.forEach(button => button.addEventListener('click', (e) => { this.ui.handleTabClick(e); }));
                this.dom.openHelpBtn.addEventListener('click', () => this.dom.helpModal.classList.add('open'));
                this.dom.closeHelpBtn.addEventListener('click', () => this.dom.helpModal.classList.remove('open'));
                this.dom.audioToggleBtn.addEventListener('click', () => this.ui.toggleAudio());
                this.dom.scenarioPresets.addEventListener('change', (e) => { if(e.target.value) { this.dom.topicInput.value = e.target.value; } });
                
                // Simplified listener - only one key to watch
                this.dom.googleApiKeyInput.addEventListener('input', () => {
                    this.ui.updateLlmSelector();
                    this.storage.saveApiKeys();
                });

                this.dom.themeBtn.addEventListener('click', () => {
                    this.dom.themeMenu.style.display = this.dom.themeMenu.style.display === 'block' ? 'none' : 'block';
                });
                this.dom.themeOptions.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const theme = e.target.dataset.theme;
                        this.ui.setTheme(theme);
                        this.dom.themeMenu.style.display = 'none';
                    });
                });
                document.addEventListener('click', (e) => {
                    if (this.dom.themeBtn && !this.dom.themeBtn.contains(e.target) && this.dom.themeMenu && !this.dom.themeMenu.contains(e.target)) {
                        this.dom.themeMenu.style.display = 'none';
                    }
                });
            },

            ui: { /* UI methods */ },
            tour: { /* Tour methods */ },
            api: { /* API methods */ },
            simulation: { /* Simulation methods */ },
            storage: { /* Storage methods */ },
            demoData: { /* Demo data */ }
        };

        // All other objects and methods follow...
        app.ui = { openPanel() { app.dom.settingsPanel.classList.add('open'); }, closePanel() { app.dom.settingsPanel.classList.remove('open'); }, clearAll(fullReset=false) { app.state.isInitializing = true; this.resetConversation(); if(fullReset) { app.dom.patientSymptomsInput.value = ''; app.dom.patientArchetypeInput.value = ''; app.dom.topicInput.value = ''; app.dom.scenarioPresets.value = ''; app.dom.patient.personalityText.value = ''; app.dom.aiDoctorModeToggle.checked = false; } this.handleDemoToggle(); app.tour.end(); if (app.dom.demoModeToggle.checked) { this.updateSimulationStatus('Welcome! Ready to start the guided tour?', true, 'Start Guided Tour'); } else { this.renderMessage('Welcome! Training Mode is active. Please configure your case.', "System", 'system'); } app.state.isInitializing = false; }, resetConversation() { app.state.consultationEnded = false; app.dom.chatWindow.innerHTML = ''; app.dom.statusPanel.style.display = 'none'; app.dom.analysisPanel.style.display = 'none'; app.state.conversationHistory = []; this.setControlState('initial'); const isDemo = app.dom.demoModeToggle.checked; app.dom.startBtn.textContent = isDemo ? 'Start Guided Tour' : 'Start Consultation'; app.dom.startBtn.disabled = false; if(isDemo) { this.updateSimulationStatus('Welcome to the Clinical Consult Simulator!', true, 'Start Guided Tour'); } else { app.ui.renderMessage('Conversation reset. You can start a new dialogue.', 'System', 'system'); } }, handleDemoToggle() { const isDemo = app.dom.demoModeToggle.checked; app.dom.startBtn.textContent = isDemo ? 'Start Guided Tour' : 'Start Consultation'; app.dom.configFields.forEach(field => field.disabled = isDemo); app.dom.scenarioPresets.disabled = isDemo; if (isDemo) { app.dom.aiDoctorModeToggle.checked = false; app.dom.aiDoctorModeToggle.disabled = true; app.dom.patientSymptomsInput.value = app.demoData.caseSetup.symptoms; app.dom.patientArchetypeInput.value = app.demoData.caseSetup.archetype; app.dom.topicInput.value = app.demoData.caseSetup.context; app.dom.patient.personalityText.value = app.demoData.demoPatientProfile; } else { app.dom.aiDoctorModeToggle.disabled = false; if (!app.state.postDemoTransition) { if (!app.state.isInitializing) { this.renderMessage("Training Mode activated.", "System", "system"); } app.dom.patientSymptomsInput.value = ''; app.dom.patientArchetypeInput.value = ''; app.dom.topicInput.value = ''; app.dom.patient.personalityText.value = ''; } } app.dom.startBtn.disabled = isDemo ? false : !app.dom.patient.personalityText.value; this.updateLlmSelector(); app.state.postDemoTransition = false; }, handleAiDoctorToggle() { this.setControlState('interactive'); }, handleTabClick(event) { const targetTab = event.currentTarget.dataset.tab; app.dom.tabButtons.forEach(btn => btn.classList.remove('active')); app.dom.tabContents.forEach(content => content.classList.remove('active')); event.currentTarget.classList.add('active'); document.getElementById(`tab-${targetTab}`).classList.add('active'); }, renderMessage(text, author, type = 'message') { const messageEl = document.createElement('div'); const typeClass = type === 'Doctor' ? 'doctor' : type === 'Patient' ? 'patient' : 'system'; messageEl.classList.add('message', typeClass); const contentP = document.createElement('p'); if (typeClass !== 'system') messageEl.innerHTML = `<span class="author">${author}</span>`; contentP.innerHTML = text; messageEl.appendChild(contentP); app.dom.chatWindow.appendChild(messageEl); app.dom.mainContent.scrollTop = app.dom.mainContent.scrollHeight; return messageEl; }, updateSimulationStatus(text, showButton = false, buttonText = '') { app.dom.statusText.textContent = text; app.dom.statusPanel.style.display = 'block'; app.dom.tourPrompt.innerHTML = ''; if(showButton) { const button = document.createElement('button'); button.textContent = buttonText; button.className = 'btn-primary'; button.onclick = () => { app.dom.statusPanel.style.display = 'none'; app.tour.start(); }; app.dom.tourPrompt.appendChild(button); } }, setPersonaGenStatus(text, success = null) { const statusEl = app.dom.personaGenStatus; statusEl.style.display = 'block'; statusEl.textContent = text; statusEl.style.color = success === true ? 'var(--success-color)' : success === false ? 'var(--error-color)' : 'var(--text-muted-color)'; if (success !== null) { app.dom.generatePatientBtn.classList.remove('highlight-pulse'); setTimeout(() => { statusEl.style.display = 'none'; }, 4000); } }, renderAnalysisReport(reportText, dashboardData) { app.dom.analysisPanel.style.display = 'block'; app.dom.analysisPanel.innerHTML = `<h3>Performance Debrief</h3>`; if (dashboardData?.dashboard) { const dashboardHtml = `<div class="dashboard"><div><h4>Communication Skills</h4><div class="bar-chart-container" id="comm-chart"></div></div><div><h4>Clinical Strategy</h4><div class="bar-chart-container" id="strat-chart"></div></div></div>`; app.dom.analysisPanel.innerHTML += dashboardHtml; const createBarItem = (item) => `<div class="bar-item"><div class="bar-label">${item.label}</div><div class="bar-wrapper"><div class="bar" style="width: ${item.value * 10}%;"></div></div><span class="bar-value">(${item.value}/10)</span></div>`; const commChart = document.getElementById('comm-chart'); commChart.innerHTML = dashboardData.dashboard.communication_skills.map(createBarItem).join(''); const stratChart = document.getElementById('strat-chart'); stratChart.innerHTML = dashboardData.dashboard.clinical_strategy.map(createBarItem).join(''); this.slowScrollTo(app.dom.mainContent, app.dom.analysisPanel.offsetTop, 1500); } setTimeout(() => { const reportContainer = document.createElement('div'); let formattedReport = reportText.replace(/### (.*)/g, '<h4>$1</h4>').replace(/\*\* (.*) \*\*/g, '<strong>$1</strong>').replace(/\* (.*)/g, '<li>$1</li>').replace(/(\r\n|\n|\r)/gm, '<br>'); reportContainer.innerHTML = formattedReport; app.dom.analysisPanel.appendChild(reportContainer); this.slowScrollTo(app.dom.mainContent, app.dom.mainContent.scrollHeight, 2500); }, 1500); }, slowScrollTo(element, to, duration) { const start = element.scrollTop; const change = to - start - 50; let startTime = null; const animateScroll = (currentTime) => { if (startTime === null) startTime = currentTime; const elapsed = currentTime - startTime; const newScrollPos = Math.easeOutQuad(elapsed, start, change, duration); element.scrollTop = newScrollPos; if (elapsed < duration) { window.requestAnimationFrame(animateScroll); } }; Math.easeOutQuad = (t, b, c, d) => { t /= d; return -c * t * (t - 2) + b; }; window.requestAnimationFrame(animateScroll); }, typeTextEffect(element, text, isTextarea, callback, speed = 50) { let i = 0; const target = isTextarea ? element : element; if(isTextarea) target.value = ''; else target.innerHTML = ''; const typing = setInterval(() => { if (i < text.length) { const content = isTextarea ? 'value' : 'innerHTML'; target[content] += text.charAt(i); if (isTextarea) { element.scrollTop = element.scrollHeight; } i++; } else { clearInterval(typing); if (callback) callback(); } }, speed); }, setLoadingState(isLoading) { app.state.isSimulationRunning = isLoading; app.dom.startBtn.disabled = isLoading; app.dom.sendBtn.disabled = isLoading; app.dom.getSuggestionBtn.disabled = isLoading; if (isLoading) { this.updateSimulationStatus('Processing...'); } else if (!app.state.consultationEnded) { app.dom.statusPanel.style.display = 'none'; } if (!app.state.consultationEnded && app.state.conversationHistory.length > 0) { const doctorMessages = app.state.conversationHistory.filter(m => m.author === 'Doctor').length; app.dom.debriefBtn.disabled = isLoading || doctorMessages < 1; } else if (!app.state.consultationEnded) { app.dom.debriefBtn.disabled = true; } if (!app.dom.demoModeToggle.checked) { app.dom.startBtn.disabled = isLoading || !app.dom.patient.personalityText.value; } }, setControlState(state) { const { startBtn, doctorInput, sendBtn, debriefBtn, getSuggestionBtn, resetConversationBtn } = app.dom; startBtn.style.display = (state === 'initial') ? 'flex' : 'none'; resetConversationBtn.style.display = 'flex'; const isAiDoctor = app.dom.aiDoctorModeToggle.checked; doctorInput.style.display = (state === 'interactive' && !isAiDoctor) ? 'flex' : 'none'; sendBtn.style.display = (state === 'interactive' && !isAiDoctor) ? 'flex' : 'none'; getSuggestionBtn.style.display = (state === 'interactive' && isAiDoctor) ? 'flex' : 'none'; debriefBtn.style.display = (state === 'interactive') ? 'flex' : 'none'; }, updateLlmSelector() { const googleKey = app.dom.googleApiKeyInput.value.trim(); [app.dom.patient.llmSelect, app.dom.doctor.llmSelect].forEach(select => { let firstAvailable = null; Array.from(select.options).forEach(option => { // Simplified logic: only Gemini is available, so just check for its key.
                const isDisabled = !googleKey;
                option.disabled = isDisabled;
                if (!isDisabled && !firstAvailable) firstAvailable = option.value;
            });
            if (firstAvailable && select.selectedOptions[0]?.disabled) {
                select.value = firstAvailable;
            } }); }, setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); app.storage.saveTheme(theme); }, toggleAudio() { app.state.audioEnabled = !app.state.audioEnabled; app.dom.audioToggleBtn.textContent = `Audio: ${app.state.audioEnabled ? 'ON' : 'OFF'}`; app.storage.saveAudioPref(app.state.audioEnabled); if (!app.state.audioEnabled) { window.speechSynthesis.cancel(); } else { window.speechSynthesis.speak(new SpeechSynthesisUtterance('')); } } };
        app.tour = { isActive: false, async start() { if (this.isActive || !app.dom.demoModeToggle.checked) return; this.isActive = true; if(!app.state.audioEnabled) app.ui.toggleAudio(); app.simulation.findDemoVoices(); const narrator = app.state.demoVoices.narrator; const speak = app.simulation.speakAndWait; const delay = (ms) => new Promise(r => setTimeout(r, ms)); const splash = app.dom.demoSplashScreen; splash.style.display = 'flex'; await delay(100); splash.style.opacity = 1; await delay(1500); await speak("Welcome to the Clinical Consult Simulator.", narrator); await delay(500); splash.style.opacity = 0; await delay(500); splash.style.display = 'none'; await speak("Let's take a quick tour of the main interface.", narrator); await delay(1000); await this.highlightElements('#theme-btn', "With the Theme button, you can change the application's color scheme. Let's try one.", narrator, async () => { app.dom.themeMenu.style.display = 'block'; await delay(500); app.ui.setTheme('medical-blue'); await delay(1500); app.ui.setTheme('teal'); await delay(500); app.dom.themeMenu.style.display = 'none'; }); await this.highlightElements('#audio-toggle-btn', "The Audio toggle enables or disables all voice synthesis, which I've just enabled for this presentation.", narrator, async () => { app.dom.audioToggleBtn.textContent = 'Audio: ON'; }); await this.highlightElements('#open-help-btn', "The User Guide provides instructions on how to use the different modes.", narrator, async () => { app.dom.helpModal.classList.add('open'); await delay(3000); app.dom.helpModal.classList.remove('open'); }); await this.highlightElements('#open-settings-btn', "And finally, the Configure Case button opens the main panel, which we'll explore now.", narrator); await delay(500); app.ui.openPanel(); await speak("This is the configuration panel, where every aspect of the simulation is defined.", narrator); await delay(1500); await speak("We start in the Setup tab.", narrator); await this.highlightElements('#tour-demo-mode', "Here you can enable or disable Demo Mode, which uses a pre-written case.", narrator); await this.highlightElements('#tour-ai-doctor-mode', "AI Doctor Mode lets you observe the AI playing both the doctor and patient roles.", narrator); await this.highlightElements('#tour-api-keys', "Below, you can enter your API keys for the language models.", narrator); await this.highlightElements('#tour-case-data', "And at the bottom, you can import or export case files to save your scenarios.", narrator); await delay(1500); document.querySelector('.tab-button[data-tab="patient-profile"]').click(); await speak("Next is the Patient Profile tab.", narrator); await delay(1000); await this.highlightElements('#tour-patient-symptoms', "First, we define the patient's key symptoms.", narrator); await new Promise(r => app.ui.typeTextEffect(app.dom.patientSymptomsInput, app.demoData.caseSetup.symptoms, true, r, 40)); await this.highlightElements('#tour-patient-archetype', "Then, we describe their personality archetype.", narrator); await new Promise(r => app.ui.typeTextEffect(app.dom.patientArchetypeInput, app.demoData.caseSetup.archetype, true, r, 40)); await this.highlightElements('#generate-patient-btn', "This information is then used to generate a detailed clinical profile via AI.", narrator); await speak("The system generates a profile with rich social and clinical history.", narrator); await new Promise(r => app.ui.typeTextEffect(app.dom.patient.personalityText, app.demoData.demoPatientProfile, true, r, 10)); await this.highlightElements('#tour-patient-ai', "Finally, you can select the specific AI model and voice for the patient.", narrator); await delay(1500); document.querySelector('.tab-button[data-tab="clinical-scenario"]').click(); await speak("The last tab is the Clinical Scenario.", narrator); await delay(1000); await this.highlightElements('#tour-scenario-presets', "You can choose from a list of pre-defined scenarios to get started quickly.", narrator); await this.highlightElements('#tour-scenario-topic', "Or write your own description of the clinical setting and the patient's state.", narrator); await new Promise(r => app.ui.typeTextEffect(app.dom.topicInput, app.demoData.caseSetup.context, true, r, 40)); await delay(1500); await speak("The configuration is now complete.", narrator); await delay(500); app.ui.closePanel(); await delay(1500); app.dom.startBtn.classList.add('highlight-pulse'); await speak("Normally, you would press this button to begin. For this demo, the consultation will start automatically.", narrator); await delay(2500); app.dom.startBtn.classList.remove('highlight-pulse'); this.end(); app.simulation.runAutomatedDemo(); }, async highlightElements(selector, text, narrator, action) { const element = document.querySelector(selector); element.classList.add('highlight-pulse'); if(text && narrator) await app.simulation.speakAndWait(text, narrator); if(action) await action(); else await new Promise(r => setTimeout(r, 2000)); element.classList.remove('highlight-pulse'); await new Promise(r => setTimeout(r, 500)); }, end() { this.isActive = false; } };
        app.api = { 
            getApiKeyForModel(model) { 
                if (model.startsWith('gemini')) return app.dom.googleApiKeyInput.value.trim();
                return null;
            },
            generatePatientProfileLLM: async function(symptoms, archetype, model) {
                const apiKey = this.getApiKeyForModel(model);
                if (!apiKey) throw new Error(`API Key for ${model} is missing.`);
                const prompt = `You are a medical simulation assistant. Your task is to generate a detailed patient profile based on the provided information. The profile should be realistic and provide enough depth for a role-playing scenario. **Key Symptoms:** ${symptoms}. **Patient Archetype:** ${archetype}. Please generate a patient profile that includes the following sections: - **Social Context:** (e.g., age, occupation, family life, relevant habits like smoking). - **Clinical History:** (Details about the onset and nature of the symptoms). - **Psychosocial Factors:** (The patient's emotional state, fears, beliefs about health, and how their archetype manifests in this situation). The response should be ONLY the generated profile text, without any introductory phrases.`;
                const payload = [{ role: 'user', parts: [{ text: prompt }] }];
                return await this.callLLM(apiKey, model, payload);
            },
            callLLM: async function(apiKey, model, payload) {
                // Refactored to support only Google Gemini API. NVIDIA logic removed.
                if (!model.startsWith('gemini')) {
                    throw new Error(`Model ${model} is not supported in this version.`);
                }
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const body = JSON.stringify({ contents: payload });
                const headers = { 'Content-Type': 'application/json' };
                
                const response = await fetch(url, { method: 'POST', headers, body });
                
                if (!response.ok) {
                    if (response.status === 429) throw new Error("API request limit reached.");
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.candidates?.[0]?.content?.parts) {
                    return data.candidates[0].content.parts[0].text;
                }
                
                throw new Error("Invalid API response structure.");
            }
        };
        app.simulation = { async runAutomatedDemo() { app.ui.setLoadingState(true); app.state.consultationEnded = false; app.ui.resetConversation(); app.ui.setControlState('interactive'); app.dom.debriefBtn.disabled = true; app.dom.doctorInput.style.display = 'none'; app.dom.sendBtn.style.display = 'none'; app.dom.getSuggestionBtn.style.display = 'none'; app.ui.updateSimulationStatus('Playing demo consultation...'); const doctorVoice = app.state.demoVoices.doctor; const patientVoice = app.state.demoVoices.patient; for (const message of app.demoData.fullDemoConversation) { const speaker = message.author === 'Patient' ? patientVoice : doctorVoice; const msgEl = app.ui.renderMessage('', message.author, message.author); const pEl = msgEl.querySelector('p'); await this.speakAndType(message.text, speaker, pEl, 40); } app.state.consultationEnded = true; const narrator = app.state.demoVoices.narrator; await this.speakAndWait("The consultation is now complete.", narrator); await this.speakAndWait("The system will now automatically generate a performance analysis.", narrator); app.dom.debriefBtn.classList.add('highlight-pulse'); await new Promise(r => setTimeout(r, 1500)); this.analyze(); await this.speakAndWait("This concludes the guided demonstration.", narrator); await new Promise(r => setTimeout(r, 1000)); await this.speakAndWait("The interface will now be prepared for your own training session.", narrator); await new Promise(r => setTimeout(r, 2500)); app.state.postDemoTransition = true; app.dom.demoModeToggle.checked = false; app.ui.handleDemoToggle(); app.ui.resetConversation(); app.ui.renderMessage("The demo case has been preserved. You can now start the consultation, modify the details, or reset the case entirely.", "System", 'system'); }, async generatePatientProfile() { const s = app.dom.patientSymptomsInput.value.trim(), a = app.dom.patientArchetypeInput.value.trim(), m = app.dom.patient.llmSelect.value; if (!s || !a) { return alert("Please define symptoms and archetype."); } app.ui.setPersonaGenStatus("Generating..."); try { const p = await app.api.generatePatientProfileLLM(s, a, m); app.dom.patient.personalityText.value = p; app.ui.setPersonaGenStatus("Success!", true); app.dom.startBtn.disabled = false; } catch (e) { app.ui.renderMessage(e.message, 'System', 'error'); app.ui.setPersonaGenStatus(`Error: ${e.message}`, false); } }, async startInteractive() { if (!app.dom.patient.personalityText.value) { return alert("Please generate a profile first!"); } app.state.consultationEnded = false; app.ui.setLoadingState(true); app.ui.closePanel(); app.ui.resetConversation(); app.ui.setControlState('interactive'); app.dom.debriefBtn.disabled = true; try { const m = app.dom.patient.llmSelect.value, k = app.api.getApiKeyForModel(m); if (!k) throw new Error(`API key for ${m} is missing.`); const context = app.dom.topicInput.value, profile = app.dom.patient.personalityText.value; const p = [{ role: 'user', parts: [{ text: `You are role-playing as a patient. Your detailed profile is: "${profile}". You find yourself in this situation: "${context}". What is the very first thing you say to the doctor? Respond ONLY with your opening line.` }] }]; const openingLine = await app.api.callLLM(k, m, p); app.ui.renderMessage(openingLine, 'Patient', 'Patient'); app.state.conversationHistory.push({ author: 'Patient', text: openingLine }); } catch (e) { app.ui.renderMessage(e.message, "System", 'error'); } app.ui.setLoadingState(false); }, async sendDoctorMessage() { const t = app.dom.doctorInput.value.trim(); if (!t || app.state.isSimulationRunning) return; this.handleDoctorResponse(t); }, getDoctorSuggestion(){}, async handleDoctorResponse(text) { app.ui.renderMessage(text, 'Doctor', 'Doctor'); app.state.conversationHistory.push({ author: 'Doctor', text }); app.dom.doctorInput.value = ''; app.ui.setLoadingState(true); const doctorMessages = app.state.conversationHistory.filter(m => m.author === 'Doctor').length; if (doctorMessages >= 1) { app.dom.debriefBtn.disabled = false; } try { const m = app.dom.patient.llmSelect.value, k = app.api.getApiKeyForModel(m); if (!k) throw new Error(`API key for ${m} is missing.`); const history = app.state.conversationHistory.map(msg => `${msg.author}: ${msg.text}`).join('\n'); const prompt = `You are role-playing as a patient. **Your Profile:**\n${app.dom.patient.personalityText.value}\n\n**Current Situation:**\n${app.dom.topicInput.value}\n\n**Conversation History:**\n${history}\n\nBased on the entire conversation and your personality, what is your immediate response to the doctor's last message? Respond ONLY with the patient's dialogue.`; const p = [{ role: 'user', parts: [{ text: prompt }] }]; const r = await app.api.callLLM(k, m, p); app.ui.renderMessage(r, 'Patient', 'Patient'); app.state.conversationHistory.push({ author: 'Patient', text: r }); } catch (e) { app.ui.renderMessage(e.message, "System", 'error'); } app.ui.setLoadingState(false); }, async analyze() { app.dom.debriefBtn.classList.remove('highlight-pulse'); app.dom.debriefBtn.disabled = true; if (app.dom.demoModeToggle.checked) { app.ui.renderAnalysisReport(app.demoData.analysis.reportText, app.demoData.analysis.dashboardData); return; } if (app.state.conversationHistory.length < 1) return; app.ui.setLoadingState(true); app.ui.setControlState('initial'); app.ui.updateSimulationStatus("Analyzing consultation..."); try { const m = 'gemini-pro', k = app.api.getApiKeyForModel(m); if (!k) throw new Error(`Gemini API key is required for analysis.`); const c = app.state.conversationHistory.map(msg => `${msg.author}: ${msg.text}`).join('\n\n'); const patientProfile = app.dom.patient.personalityText.value, scenario = app.dom.topicInput.value; const prompt = `You are a medical education expert. Analyze the following transcript. **Patient Profile:**\n${patientProfile}\n\n**Scenario:**\n${scenario}\n\n**Transcript:**\n${c}\n\nYour response MUST follow this structure EXACTLY:\n1. A valid, minified JSON object with NO newlines and NO markdown backticks. The structure must be: {"dashboard":{"communication_skills":[{"label":"Empathy & Rapport","value":0-10},{"label":"Active Listening","value":0-10},{"label":"Patient Education","value":0-10}],"clinical_strategy":[{"label":"History Taking","value":0-10},{"label":"Patient Management","value":0-10}]}}.\n2. The exact separator string: <--JSON_DATA_SEPARATOR-->\n3. A markdown report with "### Strengths", "### Areas for Improvement", and "### Specific Suggestions".`; const r = await app.api.callLLM(k, m, [{ role: 'user', parts: [{ text: prompt }] }]); const s = "<--JSON_DATA_SEPARATOR-->", i = r.indexOf(s); let d = {}, t = r; if (i !== -1) { const j = r.substring(0, i); t = r.substring(i + s.length); try { d = JSON.parse(j); } catch(e){ console.error("Failed to parse JSON debrief:", j, e); d = {}; t = "Error: Could not parse analysis data from the model's response."}} app.ui.renderAnalysisReport(t.trim(), d); } catch (e) { app.ui.renderMessage(`ANALYSIS ERROR: ${e.message}`, "System", 'error'); } app.ui.setLoadingState(false); }, speakAndWait(text, voice) { return new Promise((resolve) => { if (!app.state.audioEnabled || !('speechSynthesis' in window) || !text) return resolve(); window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); if (voice) utterance.voice = voice; utterance.onend = resolve; utterance.onerror = (e) => { console.error("TTS Error:", e); resolve(); }; window.speechSynthesis.speak(utterance); }); }, speakAndType(text, voice, element, speed) { return new Promise(resolve => { if (!app.state.audioEnabled || !text) { app.ui.typeTextEffect(element, text, false, () => setTimeout(resolve, 1200), speed); return; } const utterance = new SpeechSynthesisUtterance(text); if (voice) utterance.voice = voice; let typingStarted = false; utterance.onstart = () => { typingStarted = true; app.ui.typeTextEffect(element, text, false, null, speed); }; utterance.onend = resolve; utterance.onerror = (e) => { console.error("TTS Error:", e); if (!typingStarted) app.ui.typeTextEffect(element, text, false, null, speed); resolve(); }; window.speechSynthesis.speak(utterance); }); }, populateVoices() { return new Promise(resolve => { let attempts = 0; const interval = setInterval(() => { const voices = window.speechSynthesis.getVoices(); if (voices.length > 0) { clearInterval(interval); app.state.voices = voices.filter(v => v.lang.startsWith('en')); [app.dom.patient.voiceSelect, app.dom.doctor.voiceSelect].forEach(select => { select.innerHTML = ''; app.state.voices.forEach(v => { const option = document.createElement('option'); option.textContent = `${v.name} (${v.lang})`; option.value = v.voiceURI; select.appendChild(option); }); }); resolve(); } else if (++attempts > 10) { clearInterval(interval); console.error("Could not load voices after 10 attempts."); resolve(); } }, 200); }); }, getSelectedVoice(role) { const select = (role === 'patient') ? app.dom.patient.voiceSelect : app.dom.doctor.voiceSelect; return app.state.voices.find(v => v.voiceURI === select.value); }, findVoice(criteria) { let allVoices = app.state.voices.filter(v => v.lang.startsWith('en')); const nameCheck = (v, regex) => regex.test(v.name.toLowerCase()); let femaleVoices = allVoices.filter(v => nameCheck(v, /female|woman|zira|susan|karen|linda/i)); let maleVoices = allVoices.filter(v => nameCheck(v, /male|man|david|mark|daniel|oliver|guy/i) && !femaleVoices.some(fv => fv.name === v.name)); if (criteria.gender === 'female') return femaleVoices[0] || allVoices.find(v => !maleVoices.includes(v)) || allVoices[0]; if (criteria.gender === 'male') { let pool = maleVoices.length > 0 ? maleVoices : allVoices.filter(v => !femaleVoices.includes(v)); if (pool.length === 0) pool = allVoices; if (criteria.accent === 'GB') { let accentVoice = pool.find(v => nameCheck(v, /gb|british|uk|daniel|oliver/i)); if(accentVoice) return accentVoice; } if (criteria.exclude) pool = pool.filter(v => !criteria.exclude.includes(v.name)); return pool[0] || allVoices.find(v => v.name !== criteria.exclude?.[0]) || allVoices[0]; } return allVoices[0]; }, findDemoVoices() { app.state.demoVoices.narrator = this.findVoice({ gender: 'female' }); app.state.demoVoices.doctor = this.findVoice({ gender: 'male', accent: 'GB' }); app.state.demoVoices.patient = this.findVoice({ gender: 'male', lang: 'en-US', exclude: [app.state.demoVoices.doctor?.name] }); if (app.state.demoVoices.doctor && app.state.demoVoices.patient && app.state.demoVoices.doctor.name === app.state.demoVoices.patient.name) { let allMale = app.state.voices.filter(v => /male|man|david|mark|daniel|oliver/i.test(v.name.toLowerCase())); if (allMale.length > 1) { app.state.demoVoices.patient = allMale.find(v => v.name !== app.state.demoVoices.doctor.name); } } } };
        app.storage = { 
            saveTheme(theme) { localStorage.setItem('clinicalSimTheme', theme); }, 
            loadTheme() { const theme = localStorage.getItem('clinicalSimTheme') || 'teal'; app.ui.setTheme(theme); }, 
            saveAudioPref(isEnabled) { localStorage.setItem('clinicalSimAudio', isEnabled); }, 
            loadAudioPref() { const isEnabled = localStorage.getItem('clinicalSimAudio') === 'true'; if(isEnabled) { app.state.audioEnabled = true; app.dom.audioToggleBtn.textContent = 'Audio: ON'; }}, 
            saveApiKeys() { 
                // Simplified to only save the Google key
                localStorage.setItem('clinicalSimApiKeys', JSON.stringify({ google: app.dom.googleApiKeyInput.value })); 
            }, 
            loadApiKeys() { 
                const k = JSON.parse(localStorage.getItem('clinicalSimApiKeys')) || {}; 
                app.dom.googleApiKeyInput.value = k.google || '';
                // No longer need to load the NVIDIA key
                app.ui.updateLlmSelector(); 
            }, 
            exportCase() {}, 
            importCase() {} 
        };
        app.demoData = { caseSetup: { symptoms: 'Chest pain, shortness of breath', archetype: 'Stoic male, afraid but trying to hide it', context: `Setting: A busy emergency room on a Friday night. The patient, a man in his late 50s, is sitting on the edge of a gurney, looking pale.` }, demoPatientProfile: `Social Context: John Kowalski, 58, is a construction foreman. He is married with two adult children and smokes half a pack a day. He considers himself tough and generally avoids doctors.\n\nClinical History: About an hour ago, he experienced a sudden, crushing chest pain that radiated to his left arm, accompanied by shortness of breath. This has never happened before. His wife insisted he come to the ER.\n\nPsychosocial Factors: John's identity is built on being a strong provider. He sees illness as weakness. He is terrified this is a heart attack but is trying to downplay it. He will be terse and may seem irritated, but this is a cover for his profound fear.`, fullDemoConversation: [ { author: 'Patient', text: "They told me to wait here. It's... it's just a bad cramp in my chest." }, { author: 'Doctor', text: "I'm Dr. Evans. I'm here to help. Can you tell me exactly where you feel the pain?" }, { author: 'Patient', text: "Right here. Like a fist... squeezing." }, { author: 'Doctor', text: "Okay. And does the pain go anywhere else? Your arm, your jaw?" }, { author: 'Patient', text: "My arm... yeah. A little. It's probably nothing." }, { author: 'Doctor', text: "John, chest pain is something we take very seriously. I need to get a quick ECG and some blood work started right now. My nurse will be right with you. We're going to take good care of you." } ], analysis: { dashboardData: {"dashboard":{"communication_skills":[{"label":"Empathy & Rapport","value":8},{"label":"Active Listening","value":7},{"label":"Patient Education","value":6}],"clinical_strategy":[{"label":"History Taking","value":9},{"label":"Patient Management","value":10}]}}, reportText: `### Strengths\n- **Immediate Action & Clarity:** You took charge of the situation immediately, stating your role and intention clearly ("I'm here to help"). Your transition to action ("I need to get a quick ECG...") was direct and appropriate for an emergency setting.\n- **Effective Reassurance:** You validated the patient's fear while simultaneously conveying control and a clear plan ("chest pain is something we take very seriously," "we're going to take good care of you").\n\n### Areas for Improvement\n- **Acknowledging Emotion:** You could have explicitly acknowledged the patient's visible fear. A phrase like "This must be very frightening, but you're in the right place now" can build a powerful rapport in seconds.` } };
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>